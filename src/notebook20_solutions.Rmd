---
title: "Notebook 20 -- Solutions"
output:
  html_document:
    theme: cosmo
    highlight: zenburn
    css: "../css/note-style.css"
---

## Getting Started

Before running this notebook, select "Session > Restart R and Clear Output" in
the menu above to start a new R session. This will clear any old data sets and
give us a blank slate to start with.

After starting a new session, run the following code chunk to load the
libraries and data that we will be working with today.

```{r, include=FALSE, message=FALSE}
source("../funs/funs.R")
```

## Bird Observations in France

The data for this notebook consists of a subset of bird observations from France
between 2010 and 2019. The data comes from https://doi.org/10.15468/dl.bwuax7.
I have taken a random subsample that takes a random sample of 100k sightings
from the 100 most common species of bird. 

Below, is the main dataset, with one row per observation of a bird. It includes
the time, location, and scientific name of the bird. I will add a geospatial
attribute for you to the dataset as it will be needed in the questions below.

```{r}
source("../funs/funs.R")

birds <- read_csv("../data/french_birds.csv.bz2")
birds <- st_as_sf(birds, coords = c("lon", "lat"), crs = 4326, remove = FALSE)
birds
```

We also have a metadata table describing each of the bird species. You can join
to the `birds` data using the key "scientific_name". Most important for the questions
questions are the columns `species_common` (a common name for this bird species)
and `order_common` (a common name for a larger grouping of birds that this 
species is a part of).

```{r}
species <- read_csv("../data/french_bird_species.csv.bz2")
species
```

We also have a spatial polygon dataset describing the 96 French Départements
(roughly the equivalent of a state/county). Below, I am taking a subset to only
include those regions in France within Europe, which is the extent of the birds
data from above.

```{r}
france <- read_sf("../data/france_departement.geojson")
france <- slice(france, 1:96)
france
```

Finally, we also have a dataset describing the population of each departement.

```{r}
population <- read_csv("../data/france_departement_population.csv")
population <- slice(population, 1:96)
population
```

## 1. Observations per day of the week [temporal]

For the first question, produce a bar plot with day of the week on the x-axis
and a count of the number of bird sightings in our dataset on the y-axis. Use
full names for the days of the week.

```{r, question-01}
birds |>
  mutate(weekday = wday(date, label = TRUE, abbr = FALSE)) |>
  group_by(weekday) |>
  summarize(n = n()) |>
  ggplot(aes(weekday, n)) +
    geom_col()
```

## 2. Observations over 2015 [temporal]

Create a scatterplot with one point for each day of the year in 2015. On the
x-axis put the date and on the y-axis put the number of observations of birds
found on that day in 2015. Have the x-axis use the abbreviated month names with
breaks and minor breaks given once per month.

Hint: Use the formatting code "%b".

```{r, question-02}
birds |>
  filter(year(date) == 2015) |>
  group_by(date) |>
  summarize(n = n()) |>
  ggplot(aes(date, n)) +
    geom_point() +
    scale_x_date(
      date_breaks = "month",
      date_minor_breaks = "month",
      date_labels = "%b"
    )
```

## 3. Observations by order

Create a bar plot with common order names on the y-axis and a count of the 
number of birds across the whole dataset from each order. Arrange the y-axis
categories in descending or ascending order (your choice).

```{r, question-03}
birds |>
  inner_join(species, by = "scientific_name") |>
  group_by(order_common) |>
  summarize(n = n()) |>
  ungroup() |>
  arrange(n) |>
  mutate(order_common = fct_inorder(order_common)) |>
  ggplot(aes(n, order_common)) +
    geom_col()
```

## 4. Spatial distribution of observations [spatial] (easy)

For this question, plot the spatial locations of the `birds` data using the 
CRS projection 27561. Set the size of the points to 0.3 to make the plot easier
to read. 

Note: Feel free to change the figure height to make the plot look best on your
screen.

```{r, fig.height=6, question-04}
birds |>
  st_transform(27561) |>
  ggplot() +
    geom_sf(size = 0.3)
```

## 5. Spatial distribution of observations [spatial] (easy)

For this question, plot the spatial dataset of French departements from the 
dataset `france`, coloring the points based on their population and using the 
CRS projection 27561. Use the following color scale in the plot:

   scale_fill_distiller(
      trans = "log2", palette = "Spectral", guide = "legend", n.breaks = 5
    )

```{r, fig.height=6, question-05}
france |>
  left_join(population, by = "departement") |>
  st_transform(27561) |>
  ggplot() +
    geom_sf(aes(fill = population), size = 0) +
    scale_fill_distiller(
      trans = "log2", palette = "Spectral", guide = "legend", n.breaks = 5
    )
```

## 6. Birds in Paris [spatial]

In this question, do a spatial join of `birds` into `france`. Then, for each
bird species, compute the proportion of total sightings that occurred where
`departement == "75"` (that's the code for Paris). Order the results in
descending order and display the common species name for each species to show
those birds most commonly associated with Paris.

If your code is running very slow, note that you can (optionally) use
`as_tibble()` after the spatial join to speed things up.

Hint: You should find that the most strongly associated bird with Paris is the
"Rock dove". It sounds beautiful, but if you do an image search online you'll
see that this is the nasty pigeon-type bird that have invaded large cities all
over the world.

```{r, question-06}
birds |>
  spatial_join(france) |>
  as_tibble() |>
  left_join(species, by = "scientific_name") |>
  group_by(species_common) |>
  summarize(avg_paris = mean(departement == "75")) |>
  arrange(desc(avg_paris))
```

## 7. Distribution of bird sightings [spatial]

For this question, apply a spatial join of `birds` into `france`. 
For each unique value of `species_common` (from the `species` data), compute
the total number of departements for which each bird was observed in. Order the
table in descending order to see those species that are most pervasive across
the entire country.

```{r, question-07}
birds |>
  spatial_join(france) |>
  as_tibble() |>
  inner_join(species, by = "scientific_name") |>
  group_by(species_common, departement) |>
  summarize(n = n()) |>
  summarize(n_departement = n()) |>
  arrange(desc(n_departement))
```

## 8. Spatial distribution of observations [spatial]

Create a dataset called `bird_cnt` describing the number of birds observed in
each departement. Make sure you apply the `as_tibble()` function right after 
the join to remove spatial information from this intermediate dataset.

Make sure to both save the dataset `bird_cnt` and print out the data in the
solutions (just as I did with solution to Question 7 in Notebook 20).

```{r, fig.height=5, question-08}
bird_cnt <- birds |>
  spatial_join(france) |>
  as_tibble() |>
  group_by(departement) |>
  summarize(n = n())

bird_cnt
```

## 9. Spatial distribution of observations, cont. [spatial]

Finally, create a plot of the French departements, using the color of the 
departement to show the number of birds that were observed in each area.
Do this by doing an inner join of `france` with the dataset 
`bird_cnt` you created in the previous question. Use the CRS 27561 projection
for the plot and the following fill scale:

  scale_fill_distiller(palette = "Spectral", guide = "legend", n.breaks = 10)
  
Note: You should see that the areas with the most sightings are in the popular
birding areas of (1) the Camargue Natural Park in the South of France where the
Rhône river meets the Mediterranean Sea, (2) the Médoc and Marais Poitevin
Natural Park in the West where the Garonne and Sèvre rivers flow into the
Atlantic Ocean, and (3) the Gâtinais Park, a large natural forst just to the
southeast of Paris. 

```{r, fig.height=5, question-09}
france |>
  inner_join(bird_cnt, by = "departement") |>
  st_transform(27561) |>
  ggplot() +
    geom_sf(aes(fill = n), size = 0) +
    scale_fill_distiller(palette = "Spectral", guide = "legend", n.breaks = 10)
```

